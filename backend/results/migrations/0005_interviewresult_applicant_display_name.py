# Generated by Django 5.1.3 on 2025-12-20

from django.db import migrations, models


def populate_applicant_display_name(apps, schema_editor):
    InterviewResult = apps.get_model("results", "InterviewResult")
    Applicant = apps.get_model("applicants", "Applicant")

    # Select related to avoid repeated queries during backfill
    for result in InterviewResult.objects.select_related("applicant").all():
        applicant = getattr(result, "applicant", None)
        if not applicant:
            continue
        first = getattr(applicant, "first_name", "") or ""
        last = getattr(applicant, "last_name", "") or ""
        name = f"{first} {last}".strip()
        if name and result.applicant_display_name != name:
            InterviewResult.objects.filter(pk=result.pk).update(applicant_display_name=name)


def noop_reverse(apps, schema_editor):
    # No-op reverse; field removal handled by migration framework if rolled back.
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("results", "0004_interviewresult_idx_result_date_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="interviewresult",
            name="applicant_display_name",
            field=models.CharField(blank=True, max_length=255, help_text="Denormalized applicant name for summary views"),
        ),
        migrations.RunPython(populate_applicant_display_name, reverse_code=noop_reverse),
    ]
